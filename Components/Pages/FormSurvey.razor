@page "/survey/document"
@page "/survey/document/{DocumentId:int}"
@rendermode InteractiveServer

@using Survey.DTOs.Document
@using Survey.Services.Document
@using Survey.Entities.DocumentEntities
@using Survey.Entities.SurveyEntities
@using System.Security.Claims

@inject IDocumentSurveyService DocumentService
@inject IHttpContextAccessor HttpContext
@inject NavigationManager Navigation
@inject IUserService UserService
@inject IJSRuntime JS

<PageTitle>Form Survey</PageTitle>

<div class="container-fluid p-4">
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/survey">Survey</a></li>
                <li class="breadcrumb-item active">Form Survey</li>
            </ol>
        </nav>

        <h2 class="mb-4">Form Survey</h2>

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
            </div>
        }

        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Document No.</label>
                        <input type="text" class="form-control form-control-sm bg-light"
                            value="@(document?.DocumentNo ?? previewDocumentNo)" readonly />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Document Date</label>
                        <input type="date" class="form-control form-control-sm bg-light"
                            value="@(document?.DocumentDate.ToString("yyyy-MM-dd") ?? DateTime.Now.ToString("yyyy-MM-dd"))"
                            readonly />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Document Status</label>
                        <div>
                            <span class="badge @GetStatusBadgeClass()">@GetStatusText()</span>
                            @if (document != null && document.Status != 1)
                            {
                                <a href="/survey/list" class="ms-2 small text-decoration-none">View Approval</a>
                            }
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Created By</label>
                        <div class="fw-semibold">@((document?.RequesterEmployeeName) ?? currentUser?.Username)</div>
                        <small class="text-muted">at @(document?.DocumentDate.ToString("dd/MM/yyyy") ??
                                                    DateTime.Now.ToString("dd/MM/yyyy"))</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">Requester</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Employee ID</label>
                        <input type="text" class="form-control form-control-sm bg-light" value="@employeeInfo.EmployeeId"
                            readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Employee Name</label>
                        <input type="text" class="form-control form-control-sm bg-light" value="@employeeInfo.EmployeeName"
                            readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Position Level</label>
                        <input type="text" class="form-control form-control-sm bg-light" value="@employeeInfo.PositionLevel"
                            readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Supervisor ID</label>
                        <input type="text" class="form-control form-control-sm bg-light" value="@employeeInfo.SupervisorId"
                            readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Supervisor Name</label>
                        <input type="text" class="form-control form-control-sm bg-light"
                            value="@employeeInfo.SupervisorName" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label text-muted small">Position Name</label>
                        <input type="text" class="form-control form-control-sm bg-light" value="@employeeInfo.PositionName"
                            readonly />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Survey Pengajuan</h6>
                    <button class="btn btn-light btn-sm" type="button" @onclick="ToggleSurveySection">
                        <i class="bi @(surveySectionExpanded ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                </div>
            </div>

            @if (surveySectionExpanded)
            {
                <div class="card-body">
                    @if (document == null)
                    {
                        <!-- Template Selection -->
                        <div class="border rounded p-3 bg-light mb-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small fw-semibold">Survey Template ID</label>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control @(selectedTemplateId == null ? "" : "bg-white")"
                                            value="@(selectedTemplate?.TemplateCode ?? "")"
                                            placeholder="Click search to select template..." readonly />
                                        <button class="btn btn-primary" type="button" @onclick="OpenTemplateModal">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-semibold">Survey Template Name</label>
                                    <input type="text" class="form-control form-control-sm bg-white"
                                        value="@(selectedTemplate?.TemplateName ?? "")" readonly />
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-semibold">Theme</label>
                                    <input type="text" class="form-control form-control-sm bg-white"
                                        value="@(selectedTemplate?.Theme ?? "")" readonly />
                                </div>
                            </div>
                        </div>
                    }

                    @if (document != null && document.Answers.Any())
                    {
                        @foreach (var answer in document.Answers.OrderBy(a => a.SortOrder))
                        {
                            <div class="card mb-3 border">
                                <div class="card-body">
                                    <label class="form-label fw-semibold">@answer.SortOrder. @answer.Question</label>
                                    @if (answer.Type == (int)QuestionType.Textbox)
                                    {
                                        <input type="text" class="form-control" @bind-value="answer.Answer" @bind-value:event="oninput"
                                            disabled="@(document.IsReadOnly || IsSupervisor)" />
                                    }
                                    else if (answer.Type == (int)QuestionType.Number)
                                    {
                                        <input type="number" class="form-control" @bind-value="answer.Answer" @bind-value:event="oninput"
                                            disabled="@(document.IsReadOnly || IsSupervisor)" />
                                    }
                                    else if (answer.Type == (int)QuestionType.TextArea)
                                    {
                                        <textarea class="form-control" rows="3" @bind-value="answer.Answer" @bind-value:event="oninput"
                                            disabled="@(document.IsReadOnly || IsSupervisor)"></textarea>
                                    }
                                    else if (answer.Type == (int)QuestionType.Checkbox)
                                    {
                                        if (CanEdit)
                                        {
                                            @foreach (var option in answer.Options)
                                            {
                                                var isChecked = answer.SelectedOptionIds.Contains(option.Id);
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="@($"check_{answer.AnswerId}_{option.Id}")"
                                                        checked="@isChecked"
                                                        @onchange="@(e => UpdateCheckbox(answer.AnswerId, option.Id, (bool)e.Value!))" />
                                                    <label class="form-check-label" for="@($"check_{answer.AnswerId}_{option.Id}")">
                                                        @option.Text
                                                    </label>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            if (answer.SelectedOptionTexts != null && answer.SelectedOptionTexts.Any())
                                            {
                                                <ul class="mb-0">
                                                    @foreach (var t in answer.SelectedOptionTexts)
                                                    {
                                                        <li>@t</li>
                                                    }
                                                </ul>
                                            }
                                            else
                                            {
                                                <div class="text-muted">-</div>
                                            }
                                        }
                                    }
                                </div>
                            </div>
                        }
                    }
                    else if (document == null && preview != null && preview.Answers.Any())
                    {
                        @foreach (var answer in preview.Answers.OrderBy(a => a.SortOrder))
                        {
                            <div class="card mb-3 border">
                                <div class="card-body">
                                    <label class="form-label fw-semibold">@answer.SortOrder. @answer.Question</label>

                                    @if (answer.Type == (int)QuestionType.Textbox)
                                    {
                                        <input type="text" class="form-control" @bind-value="answer.Answer" @bind-value:event="oninput" />
                                    }
                                    else if (answer.Type == (int)QuestionType.Number)
                                    {
                                        <input type="number" class="form-control" @bind-value="answer.Answer" @bind-value:event="oninput" />
                                    }
                                    else if (answer.Type == (int)QuestionType.TextArea)
                                    {
                                        <textarea class="form-control" rows="3" @bind-value="answer.Answer"
                                            @bind-value:event="oninput"></textarea>
                                    }
                                    else if (answer.Type == (int)QuestionType.Checkbox)
                                    {
                                        @foreach (var option in answer.Options)
                                        {
                                            var isChecked = answer.SelectedOptionIds.Contains(option.Id);
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                    id="@($"preview_check_{answer.ItemId}_{option.Id}")" checked="@isChecked"
                                                    @onchange="@(e => UpdatePreviewCheckbox(answer.ItemId, option.Id, (bool)e.Value!))" />
                                                <label class="form-check-label" for="@($"preview_check_{answer.ItemId}_{option.Id}")">
                                                    @option.Text
                                                </label>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }
                    }
                    else if (selectedTemplate == null)
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Silakan pilih template survey terlebih dahulu untuk melanjutkan.
                        </div>
                    }
                </div>
            }
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" @onclick="BackToList">
                <i class="bi bi-arrow-left me-1"></i> Back to List
            </button>

            @if (!IsSupervisor && (selectedTemplateId != null || (document != null && document.Status != 3)))
            {
                <button class="btn btn-success" @onclick="SaveDraft" disabled="@isSaving">Save Draft</button>
                <button class="btn btn-primary" @onclick="Submit" disabled="@isSaving">Submit</button>
            }
            @if (IsSupervisor && document != null && document.Status == 2)
            {
                <button class="btn btn-success" @onclick="Approve" disabled="@isSaving">
                    Approve
                </button>
            }
        </div>
    }
</div>

@if (showTemplateModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Survey Template</h5>
                    <button type="button" class="btn-close" @onclick="CloseTemplateModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="Search templates..." @bind="searchQuery"
                            @bind:event="oninput" />
                    </div>

                    @if (availableTemplates.Any())
                    {
                        <div class="list-group">
                            @foreach (var template in GetFilteredTemplates())
                            {
                                <button type="button"
                                    class="list-group-item list-group-item-action @(selectedTemplateId == template.Id ? "active" : "")"
                                    @onclick="() => SelectTemplate(template)">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@template.TemplateName</h6>
                                        <small>@template.TemplateCode</small>
                                    </div>
                                    <p class="mb-1">@template.Theme</p>
                                    <small>@template.ItemCount questions</small>
                                </button>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning mb-0">No templates available.</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseTemplateModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmTemplateSelection"
                        disabled="@(selectedTemplateId == null)">
                        Select
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? DocumentId { get; set; }
    private bool CanEdit => document != null && !document.IsReadOnly && !IsSupervisor;
    private ClaimsPrincipal? User => HttpContext.HttpContext?.User;
    private string CurrentRole => User?.FindFirstValue(ClaimTypes.Role) ?? "";
    private bool IsSupervisor => CurrentRole.Equals("Supervisor", StringComparison.OrdinalIgnoreCase);
    private DocumentSurveyDto? document;
    private DocumentSurveyPreviewDto? preview;

    private bool isLoading = true;
    private bool isSaving = false;
    private bool surveySectionExpanded = true;

    private string errorMessage = string.Empty;
    private string? successMessage;
    private string previewDocumentNo = string.Empty;

    private bool showTemplateModal;
    private string searchQuery = string.Empty;
    private int? selectedTemplateId;
    private TemplateOptionDto? selectedTemplate;
    private List<TemplateOptionDto> availableTemplates = new();

    private UserInfo? currentUser;
    private EmployeeInfo employeeInfo = new();
    private TemplateInfo templateInfo = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var user = HttpContext.HttpContext?.User;

            currentUser = new UserInfo
            {
                UserId = user != null ? AuthClaims.GetUserId(user) : 0,
                Username = user?.Identity?.Name ?? "User"
            };

            availableTemplates = await DocumentService.GetTemplateOptionsAsync();
            previewDocumentNo = await DocumentService.GenerateDocumentNoAsync();

            if (DocumentId.HasValue)
            {
                document = await DocumentService.GetForRenderAsync(DocumentId.Value);
                SyncRequesterFromDocument();
            }
            else
            {
                await LoadRequesterFromLoginAsync();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadRequesterFromLoginAsync()
    {
        var userId = currentUser?.UserId ?? 0;
        if (userId <= 0) return;

        var profile = await UserService.GetRequesterProfileAsync(userId);

        employeeInfo = new EmployeeInfo
        {
            EmployeeId = profile.EmployeeId,
            EmployeeName = profile.EmployeeName,
            PositionLevel = profile.PositionLevel,
            PositionName = profile.PositionName,
            SupervisorId = profile.SupervisorId,
            SupervisorName = profile.SupervisorName
        };
    }

    private void SyncRequesterFromDocument()
    {
        if (document == null) return;

        employeeInfo = new EmployeeInfo
        {
            EmployeeId = document.RequesterEmployeeId,
            EmployeeName = document.RequesterEmployeeName,
            PositionLevel = document.RequesterPositionLevel,
            PositionName = document.RequesterPositionName,
            SupervisorId = document.SupervisorId,
            SupervisorName = document.SupervisorName
        };
    }

    private void ToggleSurveySection()
    {
        surveySectionExpanded = !surveySectionExpanded;
    }

    private void OpenTemplateModal()
    {
        if (document != null) return;
        searchQuery = string.Empty;
        showTemplateModal = true;
    }

    private void CloseTemplateModal()
    {
        showTemplateModal = false;
    }

    private void SelectTemplate(TemplateOptionDto template)
    {
        selectedTemplateId = template.Id;
        selectedTemplate = template;
        preview = null;
    }

    private async Task ConfirmTemplateSelection()
    {
        if (!selectedTemplateId.HasValue) return;

        try
        {
            preview = await DocumentService.GetPreviewFromTemplateAsync(selectedTemplateId.Value);

            templateInfo = new TemplateInfo
            {
                TemplateId = selectedTemplate?.TemplateCode ?? "",
                TemplateName = selectedTemplate?.TemplateName ?? "",
                Theme = selectedTemplate?.Theme ?? ""
            };

            showTemplateModal = false;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private List<TemplateOptionDto> GetFilteredTemplates()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
            return availableTemplates;

        return availableTemplates.Where(t =>
        t.TemplateName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
        t.TemplateCode.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
        t.Theme.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
        ).ToList();
    }
    private void UpdateCheckbox(int answerId, int optionId, bool isChecked)
    {
        var ans = document?.Answers.FirstOrDefault(x => x.AnswerId == answerId);
        if (ans == null) return;

        if (isChecked)
        {
            if (!ans.SelectedOptionIds.Contains(optionId))
                ans.SelectedOptionIds.Add(optionId);
        }
        else
        {
            ans.SelectedOptionIds.Remove(optionId);
        }
    }
    private void UpdatePreviewCheckbox(int itemId, int optionId, bool isChecked)
    {
        var ans = preview?.Answers.FirstOrDefault(x => x.ItemId == itemId);
        if (ans == null) return;

        if (isChecked)
        {
            if (!ans.SelectedOptionIds.Contains(optionId))
                ans.SelectedOptionIds.Add(optionId);
        }
        else
        {
            ans.SelectedOptionIds.Remove(optionId);
        }
    }

    private async Task CreateDocument()
    {
        if (!selectedTemplateId.HasValue) return;

        isSaving = true;
        errorMessage = string.Empty;
        successMessage = null;

        try
        {
            var req = new DocumentSurveyCreateRequestDto
            {
                DocumentNo = await DocumentService.GenerateDocumentNoAsync(),
                DocumentDate = DateTime.Now,
                TemplateHeaderId = selectedTemplateId.Value,

                CreatedByUserId = currentUser?.UserId ?? 0,
                CreatedByUserName = currentUser?.Username ?? "User",

                RequesterEmployeeId = employeeInfo.EmployeeId,
                RequesterEmployeeName = employeeInfo.EmployeeName,
                RequesterPositionLevel = employeeInfo.PositionLevel,
                RequesterPositionName = employeeInfo.PositionName,
                SupervisorId = employeeInfo.SupervisorId,
                SupervisorName = employeeInfo.SupervisorName
            };

            var documentId = await DocumentService.CreateDraftFromTemplateAsync(req);

            Navigation.NavigateTo($"/survey/document/{documentId}", true);
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task SaveDraft()
    {
        isSaving = true;
        errorMessage = string.Empty;
        successMessage = null;

        try
        {
            await EnsureDocumentCreatedAsync();
            foreach (var a in document!.Answers.OrderBy(x => x.SortOrder))
            {
                Console.WriteLine($"AnswerId={a.AnswerId} Type={a.Type} Q={a.Question} Answer='{a.Answer ?? "<NULL>"}' Selected=[{string.Join(",", a.SelectedOptionIds)}]");
            }

            await DocumentService.SaveDraftAsync(new DocumentSurveySaveRequestDto
            {
                DocumentId = document!.Id,
                Answers = document.Answers.Select(a => new DocumentSurveyAnswerSaveDto
                {
                    AnswerId = a.AnswerId,
                    Answer = a.Answer,
                    SelectedCheckboxOptionIds = a.SelectedOptionIds
                }).ToList()
            });

            document = await DocumentService.GetForRenderAsync(document.Id);

            successMessage = "Draft saved successfully!";
            
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task Submit()
    {
        isSaving = true;
        errorMessage = string.Empty;
        successMessage = null;

        try
        {
            await EnsureDocumentCreatedAsync();

            await DocumentService.SaveDraftAsync(new DocumentSurveySaveRequestDto
            {
                DocumentId = document!.Id,
                Answers = document.Answers.Select(a => new DocumentSurveyAnswerSaveDto
                {
                    AnswerId = a.AnswerId,
                    Answer = a.Answer,
                    SelectedCheckboxOptionIds = a.SelectedOptionIds
                }).ToList()
            });

            await DocumentService.SubmitAsync(document.Id);

            document = await DocumentService.GetForRenderAsync(document.Id);
            successMessage = "Document submitted successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }
    private async Task Approve()
    {
        if (document == null) return;

        isSaving = true;
        errorMessage = string.Empty;
        successMessage = null;

        try
        {
            await DocumentService.ApproveAsync(document.Id); // kamu perlu bikin method ini di service
            document = await DocumentService.GetForRenderAsync(document.Id);
            successMessage = "Approved successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task EnsureDocumentCreatedAsync()
    {
        if (document != null) return;
        if (!selectedTemplateId.HasValue)
            throw new InvalidOperationException("Pilih template dulu.");

        var req = new DocumentSurveyCreateRequestDto
        {
            DocumentNo = await DocumentService.GenerateDocumentNoAsync(),
            DocumentDate = DateTime.Now,
            TemplateHeaderId = selectedTemplateId.Value,

            CreatedByUserId = currentUser?.UserId ?? 0,
            CreatedByUserName = currentUser?.Username ?? "User",

            RequesterEmployeeId = employeeInfo.EmployeeId,
            RequesterEmployeeName = employeeInfo.EmployeeName,
            RequesterPositionLevel = employeeInfo.PositionLevel,
            RequesterPositionName = employeeInfo.PositionName,
            SupervisorId = employeeInfo.SupervisorId,
            SupervisorName = employeeInfo.SupervisorName
        };

        var newId = await DocumentService.CreateDraftFromTemplateAsync(req);
        document = await DocumentService.GetForRenderAsync(newId);

        if (preview != null)
        {
            var map = preview.Answers.ToDictionary(x => x.ItemId);
            foreach (var d in document.Answers)
            {
                if (map.TryGetValue(d.ItemId, out var p))
                {
                    d.Answer = p.Answer;
                    d.SelectedOptionIds = p.SelectedOptionIds?.ToList() ?? new();
                }
            }
        }

    }

    private void BackToList()
    {
        Navigation.NavigateTo("/survey/list");
    }

    private string GetStatusBadgeClass()
    {
        if (document == null) return "bg-secondary";
        return document.Status switch
        {
            1 => "bg-secondary",
            2 => "bg-warning text-dark",
            3 => "bg-success",
            _ => "bg-secondary"
        };
    }

    private string GetStatusText()
    {
        if (document == null) return "New";
        return document.Status switch
        {
            0 => "New",
            1 => "Draft",
            2 => "Confirm To Approve",
            3 => "Confirmed",
            _ => "New"
        };
    }

    private class UserInfo
    {
        public int UserId { get; set; }
        public string Username { get; set; } = "";
    }

    private class EmployeeInfo
    {
        public string EmployeeId { get; set; } = "";
        public string EmployeeName { get; set; } = "";
        public string PositionLevel { get; set; } = "";
        public string SupervisorId { get; set; } = "";
        public string SupervisorName { get; set; } = "";
        public string PositionName { get; set; } = "";
    }

    private class TemplateInfo
    {
        public string TemplateId { get; set; } = "";
        public string TemplateName { get; set; } = "";
        public string Theme { get; set; } = "";
    }
}