@page "/master-user"
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

@inject IUserService UserService
@inject IUserRepository UserRepo
@inject IHttpContextAccessor HttpContextAccessor
@inject NavigationManager Navigation
@inject IPositionService PositionService


<PageTitle>Master User</PageTitle>

<div class="container-fluid py-3">
    <div class="mb-3">
        <span class="text-primary">User</span>
        <span class="mx-2">â†’</span>
        <span>Master User</span>
    </div>

    <h2 class="mb-3">Master User</h2>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success">@successMessage</div>
    }

    <div class="card shadow-sm border rounded-3">
        <div class="card-body p-4">

            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="bg-info bg-opacity-25 rounded-3 d-flex align-items-center justify-content-center"
                    style="width:44px;height:44px;">
                    <i class="bi bi-people" style="font-size:20px;"></i>
                </div>
                <h3 class="m-0">User</h3>
            </div>

            <EditForm Model="@form" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">User Id</label>
                        <div class="input-group">
                            <InputNumber class="form-control bg-light" @bind-Value="form.UserId" readonly />
                            <button class="btn btn-primary" type="button" @onclick="OpenUserModal"
                                disabled="@isLoadingUserList">
                                @if (isLoadingUserList)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                else
                                {
                                    <i class="bi bi-search"></i>
                                }
                            </button>
                        </div>
                        <small class="text-muted">Klik search untuk pilih user (mode edit). Untuk create user, biarkan
                            kosong.</small>
                    </div>

                    <!-- USERNAME -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">User Name</label>
                        <InputText class="form-control" @bind-Value="form.Username" />
                        <ValidationMessage For="@(() => form.Username)" />
                    </div>

                    <!-- POSITION LEVEL -->
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Position Level</label>
                        <InputSelect class="form-select" @bind-Value="form.PositionId" @onchange="OnPositionChanged">
                            <option value="0">-- Pilih Position --</option>
                            @foreach (var pos in positions)
                            {
                                <option value="@pos.Id">@pos.Name</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => form.PositionId)" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Position Name</label>
                        <InputText class="form-control" @bind-Value="form.PositionName" />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Supervisor Id</label>
                        <div class="input-group">
                            <InputNumber class="form-control bg-light" @bind-Value="form.SupervisorId"
                                readonly="true" />
                            <button class="btn btn-primary" type="button" @onclick="OpenSupervisorModal"
                                disabled="@(!allowPickSupervisor || isLoadingSupervisorList)">
                                @if (isLoadingSupervisorList)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                else
                                {
                                    <i class="bi bi-search"></i>
                                }
                            </button>
                        </div>
                        @if (!allowPickSupervisor)
                        {
                            <small class="text-muted">Supervisor otomatis dari user yang login (Opsi A).</small>
                        }
                        else
                        {
                            <small class="text-muted">Klik search untuk pilih supervisor.</small>
                        }
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Supervisor Name</label>
                        <input class="form-control bg-light" value="@supervisorName" readonly />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Supervisor Position Name</label>
                        <input class="form-control bg-light" value="@supervisorPosition" readonly />
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-4 gap-2">
                    <button type="button" class="btn btn-outline-secondary" @onclick="ResetForm" disabled="@isSaving">
                        Reset
                    </button>

                    <button type="submit" class="btn @(IsEditMode ? "btn-warning" : "btn-success") px-4"
                        disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Menyimpan...</span>
                        }
                        else
                        {
                            <span>@(IsEditMode ? "Update" : "Create")</span>
                        }
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@if (showUserModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,.5);" @onclick="CloseUserModal">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pilih User</h5>
                    <button type="button" class="btn-close" @onclick="CloseUserModal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-2 mb-3">
                        <input class="form-control" placeholder="Cari username..." @bind="userSearch"
                            @bind:event="oninput" />
                        <button class="btn btn-outline-secondary" @onclick="ClearUserSearch">Clear</button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th style="width:120px;">Id</th>
                                    <th>Username</th>
                                    <th style="width:220px;">Position</th>
                                    <th style="width:120px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var u in FilterUsers(userList, userSearch))
                                {
                                    <tr>
                                        <td>@u.Id</td>
                                        <td>@u.Username</td>
                                        <td>@u.PositionName</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-primary" @onclick="() => SelectUser(u)">Pilih</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        @if (userList.Count == 0)
                        {
                            <div class="text-muted">Tidak ada data user.</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (showSupervisorModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,.5);" @onclick="CloseSupervisorModal">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pilih Supervisor</h5>
                    <button type="button" class="btn-close" @onclick="CloseSupervisorModal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-2 mb-3">
                        <input class="form-control" placeholder="Cari username..." @bind="supervisorSearch"
                            @bind:event="oninput" />
                        <button class="btn btn-outline-secondary" @onclick="ClearSupervisorSearch">Clear</button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th style="width:120px;">Id</th>
                                    <th>Username</th>
                                    <th style="width:220px;">Position</th>
                                    <th style="width:120px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var s in FilterSupervisors(supervisorList, supervisorSearch))
                                {
                                    <tr>
                                        <td>@s.Id</td>
                                        <td>@s.Username</td>
                                        <td>@s.PositionName</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-primary"
                                                @onclick="() => SelectSupervisor(s)">Pilih</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        @if (supervisorList.Count == 0)
                        {
                            <div class="text-muted">Tidak ada data supervisor.</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool allowPickSupervisor = true;
    private bool IsEditMode => form.UserId.HasValue;
    private MasterUserForm form = new();
    private bool isSaving = false;
    private string errorMessage = "";
    private string successMessage = "";

    private string supervisorName = "";
    private string supervisorPosition = "";

    // modal state
    private bool showUserModal = false;
    private bool showSupervisorModal = false;

    private bool isLoadingUserList = false;
    private bool isLoadingSupervisorList = false;

    private string userSearch = "";
    private string supervisorSearch = "";

    private List<UserDto> userList = new();
    private List<SuperVisorInfoDto> supervisorList = new();
    private List<PositionDto> positions = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var supervisorId = GetLoggedInUserId();
        if (supervisorId <= 0)
        {
            Navigation.NavigateTo("/", forceLoad: true);
            return;
        }
        
        await LoadPositions();
        form.SupervisorId = supervisorId;
        await LoadSupervisorInfo(supervisorId);

        SyncPositionName();
        StateHasChanged();
    }

    private int GetLoggedInUserId()
    {
        var idStr = HttpContextAccessor.HttpContext?.User?.FindFirstValue(ClaimTypes.NameIdentifier);
        return int.TryParse(idStr, out var id) ? id : 0;
    }

    private void OnPositionChanged(ChangeEventArgs _)
    {
        SyncPositionName();
    }

    private void SyncPositionName()
    {
        var pos = positions.FirstOrDefault(x => x.Id == form.PositionId);
        form.PositionName = pos?.Name ?? "";
    }

    private async Task OpenUserModal()
    {
        showUserModal = true;

        if (userList.Count == 0)
            await LoadUserList();
    }
    private async Task LoadPositions()
    {
        try
        {
            positions = await PositionService.GetAllAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load position: {ex.Message}";
            positions = new();
        }
    }

    private void CloseUserModal() => showUserModal = false;
    private async Task LoadUserList()
    {
        try
        {
            isLoadingUserList = true;
            errorMessage = "";

            var supervisorId = GetLoggedInUserId();
            if (supervisorId <= 0)
                throw new UnauthorizedAccessException("Session tidak valid.");

            userList = await UserService.GetUserAsync(supervisorId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load list user. ({ex.Message})";
            userList = new();
        }
        finally
        {
            isLoadingUserList = false;
        }
    }

    private void SelectUser(UserDto u)
    {
        form.UserId = u.Id;
        form.Username = u.Username;
        form.PositionId = u.PositionId;
        form.PositionName = u.PositionName;
        showUserModal = false;
    }

    private IEnumerable<UserDto> FilterUsers(List<UserDto> list, string q)
    {
        if (string.IsNullOrWhiteSpace(q)) return list;
        q = q.Trim().ToLowerInvariant();
        return list.Where(x => (x.Username ?? "").ToLowerInvariant().Contains(q));
    }

    private void ClearUserSearch() => userSearch = "";

    private async Task OpenSupervisorModal()
    {
        if (!allowPickSupervisor) return;

        showSupervisorModal = true;
        if (supervisorList.Count == 0)
            await LoadSupervisorList();
    }

    private void CloseSupervisorModal() => showSupervisorModal = false;

    private async Task LoadSupervisorList()
    {
        try
        {
            isLoadingSupervisorList = true;
            errorMessage = "";

            var entities = await UserRepo.GetAllSupervisorsAsync();
            supervisorList = entities.Select(s => new SuperVisorInfoDto
            {
                Id = s.Id,
                Username = s.Username,
                PositionId = s.PositionId,
                PositionName = s.PositionName
            }).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load list supervisor. ({ex.Message})";
            supervisorList = new();
        }
        finally
        {
            isLoadingSupervisorList = false;
        }
    }

    private async Task SelectSupervisor(SuperVisorInfoDto s)
    {
        form.SupervisorId = s.Id;
        supervisorName = s.Username;
        supervisorPosition = s.PositionName;
        showSupervisorModal = false;

        await Task.CompletedTask;
    }

    private IEnumerable<SuperVisorInfoDto> FilterSupervisors(List<SuperVisorInfoDto> list, string q)
    {
        if (string.IsNullOrWhiteSpace(q)) return list;
        q = q.Trim().ToLowerInvariant();
        return list.Where(x => (x.Username ?? "").ToLowerInvariant().Contains(q));
    }

    private void ClearSupervisorSearch() => supervisorSearch = "";

    private async Task LoadSupervisorInfo(int id)
    {
        try
        {
            var s = await UserRepo.GetByIdWithRoleAsync(id);
            supervisorName = s?.Username ?? "";
            supervisorPosition = s?.PositionName ?? "";
        }
        catch
        {
            supervisorName = "";
            supervisorPosition = "";
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSaving = true;
            errorMessage = "";
            successMessage = "";

            var supervisorId = GetLoggedInUserId();
            if (supervisorId <= 0)
                throw new UnauthorizedAccessException("Session tidak valid.");

            if (IsEditMode)
            {
                var dto = new UpdateUserDto
                {
                    Id = form.UserId!.Value,
                    PositionId = form.PositionId,
                    PositionName = form.PositionName,
                    SupervisorId = form.SupervisorId
                };

                await UserService.UpdateUserAsync(supervisorId, dto);
                successMessage = "User berhasil diupdate.";
            }
            else
            {
                var dto = new CreateUserDto
                {
                    Username = form.Username,
                    Password = "password",
                    PositionId = form.PositionId,
                    PositionName = form.PositionName,
                    SupervisorId = form.SupervisorId
                };

                await UserService.CreateUserAsync(supervisorId, dto);
                successMessage = "User berhasil dibuat.";
            }

            ResetForm();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ResetForm()
    {
        var keepSupervisor = form.SupervisorId;
        form = new MasterUserForm { SupervisorId = keepSupervisor };
        SyncPositionName();
    }

    public class MasterUserForm
    {
        public int? UserId { get; set; }

        [Required(ErrorMessage = "Username wajib diisi")]
        public string Username { get; set; } = "";

        [Range(1, int.MaxValue, ErrorMessage = "Position wajib dipilih")]
        public int PositionId { get; set; }

        public string PositionName { get; set; } = "";
        public int SupervisorId { get; set; }
    }
}