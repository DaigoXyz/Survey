@page "/master-template-survey"
@page "/master-template-survey/{HeaderId:int}"
@using Survey.Entities.SurveyEntities
@using Survey.Services.Survey
@inject ISurveyTemplateService SurveyService
@inject IPositionService PositionService
@inject IPositionRepository PositionRepo
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Master Template Survey</PageTitle>

<div class="container-fluid p-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/survey">Survey</a></li>
            <li class="breadcrumb-item active">Master Template Survey</li>
        </ol>
    </nav>

    <h2 class="mb-4">Master Template Survey</h2>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    <!-- Survey Header Card -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0">Survey Header</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label text-muted small">Survey Template ID</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control bg-light" value="@templateCode" readonly />
                        <button class="btn btn-primary" type="button" @onclick="OpenTemplateModal">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <small class="text-muted">Format: TEMPLATE/YYMM/XXX (Auto-generate)</small>
                </div>

                <div class="col-md-6">
                    <label class="form-label text-muted small">Survey Template Name</label>
                    <input type="text" class="form-control form-control-sm" @bind="templateName"
                        placeholder="Template Survey 1" />
                </div>

                <div class="col-md-6">
                    <label class="form-label text-muted small">Position Level</label>
                    <select class="form-select form-select-sm" @bind="positionId">
                        <option value="0">-- Select Position Level --</option>
                        @foreach (var p in positions)
                        {
                            <option value="@p.Id">@p.Name</option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label text-muted small">Theme</label>
                    <input type="text" class="form-control form-control-sm" @bind="theme"
                        placeholder="Pengajuan Barang" />
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Items Card -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white" role="button" @onclick="ToggleSurveySection">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Survey Pengajuan</h6>
                <i class="bi @(isSurveySectionExpanded ? "bi-chevron-up" : "bi-chevron-down")"></i>
            </div>
        </div>

        @if (isSurveySectionExpanded)
        {
            <div class="card-body">
                <button class="btn btn-primary btn-sm mb-3" @onclick="OpenAddItemModal">
                    <i class="bi bi-plus-circle me-1"></i>Add New Item
                </button>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle mb-0">
                        <thead class="table-primary">
                            <tr>
                                <th style="width: 120px;">Action</th>
                                <th>Question</th>
                                <th style="width: 150px;">Type</th>
                                <th style="width: 100px;">Order</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (items.Any())
                            {
                                @foreach (var (item, index) in items.Select((it, i) => (it, i)))
                                {
                                    <tr>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" @onclick="() => EditItem(item)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" @onclick="() => DeleteItem(item.Id)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td>@item.Question</td>
                                        <td><span class="badge bg-secondary">@item.Type.ToString()</span></td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary"
                                                    @onclick="@(() => ReorderItem(item.Id, "UP"))" disabled="@(index == 0)">
                                                    <i class="bi bi-chevron-up"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary"
                                                    @onclick="@(() => ReorderItem(item.Id, "DOWN"))"
                                                    disabled="@(index == items.Count - 1)">
                                                    <i class="bi bi-chevron-down"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox me-2"></i>
                                        Belum ada pertanyaan. Klik "Add New Item" untuk menambahkan.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-secondary" @onclick="NewTemplate">
            <i class="bi bi-plus-circle me-1"></i>New
        </button>

        <button class="btn btn-success" @onclick="HandleSubmit" disabled="@isSaving">
            @if (isSaving)
            {
                <span class="spinner-border spinner-border-sm me-1"></span>
            }
            else
            {
                <i class="bi bi-floppy me-1"></i>
            }
            Submit
        </button>

        <button class="btn btn-danger" @onclick="HandleDelete" disabled="@(headerId == null)">
            <i class="bi bi-trash me-1"></i>Delete
        </button>
    </div>
</div>

@if (showItemModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingItemId.HasValue ? "Edit Item" : "Add New Item")</h5>
                    <button type="button" class="btn-close" @onclick="CloseItemModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Question</label>
                        <input type="text" class="form-control" @bind="currentQuestion" placeholder="Nama Barang" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" @bind="currentType">
                            <option value="">-- Select Type --</option>
                            <option value="Textbox">Textbox</option>
                            <option value="Checkbox">Checkbox</option>
                            <option value="TextArea">TextArea</option>
                            <option value="Number">Number</option>
                        </select>
                    </div>

                    @if (currentType == "Checkbox")
                    {
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Checkbox Options</h6>
                                <button class="btn btn-primary btn-sm" @onclick="AddCheckboxOption">
                                    <i class="bi bi-plus-circle me-1"></i>Add Item
                                </button>
                            </div>

                            @if (currentCheckboxOptions.Any())
                            {
                                <div class="list-group">
                                    @foreach (var (opt, idx) in currentCheckboxOptions.Select((o, i) => (o, i)))
                                    {
                                        <div class="list-group-item">
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control" @bind="currentCheckboxOptions[idx]"
                                                    placeholder="Item name" />
                                                <button class="btn btn-outline-danger" @onclick="() => DeleteCheckboxOption(idx)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Belum ada item. Klik "Add Item" untuk menambahkan.
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseItemModal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-success" @onclick="SaveItem">
                        <i class="bi bi-floppy me-1"></i>Save
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showTemplateModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pilih Survey Template</h5>
                    <button type="button" class="btn-close" @onclick="CloseTemplateModal"></button>
                </div>

                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input class="form-control" placeholder="Cari template code / name..." @bind="templateSearch"
                            @bind:event="oninput" />
                        <button class="btn btn-outline-secondary" @onclick="ClearTemplateSearch">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>

                    @if (templateList.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Template Code</th>
                                        <th>Template Name</th>
                                        <th>Position</th>
                                        <th>Theme</th>
                                        <th style="width: 100px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var t in FilterTemplates(
                                                                templateList.Where(x => x.PositionId == CurrentPositionId),
                                                                templateSearch))
                                    {
                                        <tr>
                                            <td>@t.TemplateCode</td>
                                            <td>@t.TemplateName</td>
                                            <td>@t.PositionId</td>
                                            <td>@t.Theme</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm w-100" @onclick="() => SelectTemplate(t)">
                                                    Select
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Tidak ada data template.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? HeaderId { get; set; }
    private int? headerId;
    private string templateCode = "Auto-generate";
    private string templateName = "";
    private int positionId = 0;
    private int CurrentPositionId;
    private string theme = "";
    private bool showTemplateModal = false;
    private string templateSearch = "";
    private List<SurveyHeaderListDto> templateList = new();

    private bool isSurveySectionExpanded = true;
    private bool showItemModal = false;
    private bool isSaving = false;

    private string errorMessage = "";
    private string successMessage = "";
    private List<PositionDto> positions = new();

    private List<SurveyItemDto> items = new();

    private int? editingItemId = null;
    private string currentQuestion = "";
    private string currentType = "";
    private List<string> currentCheckboxOptions = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var user = HttpContextAccessor.HttpContext?.User;
        if (user?.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/", forceLoad: true);
            return;
        }
        CurrentPositionId = AuthClaims.GetPositionId(user);
        await LoadPositions();

        if (HeaderId.HasValue)
            await LoadHeader(HeaderId.Value);

        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadPositions()
    {
        try
        {
            positions = await PositionService.GetAllAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load position: {ex.Message}";
            positions = new();
        }
    }

    private async Task LoadHeader(int id)
    {
        try
        {
            var detail = await SurveyService.GetDetailAsync(id, CancellationToken.None);
            if (detail != null)
            {
                headerId = detail.Id;
                templateCode = detail.TemplateCode;
                templateName = detail.TemplateName;
                positionId = detail.PositionId;
                theme = detail.Theme;
                items = detail.Items ?? new();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load template: {ex.Message}";
        }
    }

    private void ToggleSurveySection() => isSurveySectionExpanded = !isSurveySectionExpanded;

    private void OpenAddItemModal()
    {
        if (!headerId.HasValue)
        {
            errorMessage = "Simpan header dulu sebelum menambahkan item";
            return;
        }

        currentQuestion = "";
        currentType = "";
        currentCheckboxOptions = new();
        editingItemId = null;
        showItemModal = true;
    }

    private void EditItem(SurveyItemDto item)
    {
        currentQuestion = item.Question;
        currentType = item.Type.ToString();
        currentCheckboxOptions = item.CheckboxOptions?.Select(o => o.Name).ToList() ?? new();
        editingItemId = item.Id;
        showItemModal = true;
    }

    private void CloseItemModal()
    {
        showItemModal = false;
        currentQuestion = "";
        currentType = "";
        currentCheckboxOptions = new();
        editingItemId = null;
    }

    private void AddCheckboxOption() => currentCheckboxOptions.Add("");

    private void DeleteCheckboxOption(int index)
    {
        if (index >= 0 && index < currentCheckboxOptions.Count)
            currentCheckboxOptions.RemoveAt(index);
    }

    private async Task SaveItem()
    {
        try
        {
            errorMessage = "";
            successMessage = "";

            if (!headerId.HasValue)
            {
                errorMessage = "Header belum ada. Simpan header dulu.";
                return;
            }

            if (string.IsNullOrWhiteSpace(currentQuestion))
            {
                errorMessage = "Question tidak boleh kosong";
                return;
            }

            if (string.IsNullOrWhiteSpace(currentType))
            {
                errorMessage = "Type harus dipilih";
                return;
            }

            if (!Enum.TryParse<QuestionType>(currentType, out var questionType))
            {
                errorMessage = "Type tidak valid";
                return;
            }

            var options = currentType == "Checkbox"
                            ? currentCheckboxOptions.Where(x => !string.IsNullOrWhiteSpace(x)).ToList()
            : null;

            if (currentType == "Checkbox" && (options == null || !options.Any()))
            {
                errorMessage = "Checkbox harus memiliki minimal 1 item";
                return;
            }

            if (editingItemId.HasValue)
            {
                var updateDto = new SurveyItemUpdateDto(currentQuestion, questionType, options);
                await SurveyService.UpdateItemAsync(editingItemId.Value, updateDto, CancellationToken.None);
                successMessage = "Item berhasil diupdate";
            }
            else
            {
                var createDto = new SurveyItemCreateDto(currentQuestion, questionType, options);
                await SurveyService.AddItemAsync(headerId.Value, createDto, CancellationToken.None);
                successMessage = "Item berhasil ditambahkan";
            }

            await LoadHeader(headerId.Value);
            CloseItemModal();
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal menyimpan item: {ex.Message}";
        }
    }

    private async Task DeleteItem(int itemId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Hapus item ini?");
        if (!confirmed) return;

        try
        {
            errorMessage = "";
            successMessage = "";

            await SurveyService.DeleteItemAsync(itemId, CancellationToken.None);

            if (headerId.HasValue)
                await LoadHeader(headerId.Value);

            successMessage = "Item berhasil dihapus";
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal hapus item: {ex.Message}";
        }
    }

    private async Task ReorderItem(int itemId, string direction)
    {
        try
        {
            errorMessage = "";
            successMessage = "";

            if (!headerId.HasValue) return;

            await SurveyService.ReorderItemAsync(headerId.Value, new ReorderItemDto(itemId, direction), CancellationToken.None);

            await LoadHeader(headerId.Value);
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal reorder: {ex.Message}";
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSaving = true;
            errorMessage = "";
            successMessage = "";

            if (string.IsNullOrWhiteSpace(templateName))
            {
                errorMessage = "Survey Template Name wajib diisi";
                return;
            }

            if (positionId == 0)
            {
                errorMessage = "Position Level wajib dipilih";
                return;
            }

            if (headerId.HasValue)
            {
                var updateDto = new SurveyHeaderUpdateDto(templateName, positionId, theme);
                await SurveyService.UpdateHeaderAsync(headerId.Value, updateDto, CancellationToken.None);
                successMessage = "Template berhasil diupdate";
            }
            else
            {
                var createDto = new SurveyHeaderCreateDto(templateName, positionId, theme);
                var created = await SurveyService.CreateHeaderAsync(createDto, CancellationToken.None);

                headerId = created.Id;
                templateCode = created.TemplateCode;

                successMessage = "Template berhasil dibuat";
                Navigation.NavigateTo($"/master-template-survey/{created.Id}", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleDelete()
    {
        if (!headerId.HasValue) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Hapus template ini?");
        if (!confirmed) return;

        try
        {
            errorMessage = "";
            successMessage = "";

            await SurveyService.DeleteHeaderAsync(headerId.Value, CancellationToken.None);

            Navigation.NavigateTo("/survey-template-list", forceLoad: true);
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal hapus template: {ex.Message}";
        }
    }

    private async Task OpenTemplateModal()
    {
        showTemplateModal = true;
        templateSearch = "";
        await LoadTemplates();
    }

    private void CloseTemplateModal() => showTemplateModal = false;

    private void ClearTemplateSearch() => templateSearch = "";

    private async Task LoadTemplates()
    {
        try
        {
            templateList = await SurveyService.ListAsync(CancellationToken.None);
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load templates: {ex.Message}";
            templateList = new();
        }
    }

    private IEnumerable<SurveyHeaderListDto> FilterTemplates(
    IEnumerable<SurveyHeaderListDto> list,
    string search)
    {
        if (string.IsNullOrWhiteSpace(search))
            return list;

        var q = search.Trim().ToLowerInvariant();

        return list.Where(t =>
        (t.TemplateCode ?? "").ToLowerInvariant().Contains(q) ||
        (t.TemplateName ?? "").ToLowerInvariant().Contains(q) ||
        (t.Theme ?? "").ToLowerInvariant().Contains(q)
        );
    }

    private async Task SelectTemplate(SurveyHeaderListDto t)
    {
        CloseTemplateModal();
        Navigation.NavigateTo($"/master-template-survey/{t.Id}", forceLoad: true);
        await Task.CompletedTask;
    }

    private void NewTemplate()
    {
        HeaderId = null;
        headerId = null;

        templateCode = "Auto-generate";
        templateName = "";
        positionId = 0;
        theme = "";

        items = new();
        editingItemId = null;
        showItemModal = false;
        showTemplateModal = false;

        errorMessage = "";
        successMessage = "";

        Navigation.NavigateTo("/master-template-survey", forceLoad: true);
    }
}