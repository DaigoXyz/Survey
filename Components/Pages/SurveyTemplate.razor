@page "/master-template-survey"
@page "/master-template-survey/{HeaderId:int}"
@rendermode InteractiveServer
@using Survey.DTOs.Survey
@using Survey.DTOs.User
@using Survey.Entities.SurveyEntities
@using System.Net.Http.Headers
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Master Template Survey</PageTitle>

<div class="container-fluid py-3">
    <div class="mb-3">
        <a href="#" class="text-primary text-decoration-none">Survey</a>
        <span class="mx-2">â†’</span>
        <span>Master Template Survey</span>
    </div>

    <h2 class="mb-4">Master Template Survey</h2>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    <!-- Survey Header Card -->
    <div class="card shadow-sm mb-4 border">
        <div class="card-body p-4">
            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="bg-info bg-opacity-25 rounded-3 p-2">
                    <i class="bi bi-file-earmark-text fs-4"></i>
                </div>
                <h4 class="mb-0">Survey Header</h4>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Survey Template ID</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-light" value="@templateCode" readonly />
                        <button class="btn btn-primary" type="button" @onclick="OpenTemplateModal">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <small class="text-muted">Format: TEMPLATE/YYMM/XXX (Auto-generate)</small>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Survey Template Name</label>
                    <input type="text" class="form-control" @bind="templateName" placeholder="Template Survey 1" />
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Position Level</label>
                    <select class="form-select" @bind="positionId">
                        <option value="0">-- Select Position Level --</option>

                        @foreach (var p in positions)
                        {
                            <option value="@p.Id">@p.Name</option>
                        }
                    </select>
                </div>


                <div class="col-md-6">
                    <label class="form-label fw-semibold">Theme</label>
                    <input type="text" class="form-control" @bind="theme" placeholder="Pengajuan Barang" />
                </div>
            </div>
        </div>
    </div>
    <div class="card shadow-sm border">
        <div class="card-header text-white" style="background-color: #00066f; cursor: pointer;"
            @onclick="ToggleSurveySection">
            <div class="d-flex justify-content-between align-items-center py-2">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-people fs-5"></i>
                    <h5 class="mb-0">Survey Pengajuan</h5>
                </div>
                <i class="bi @(isSurveySectionExpanded ? "bi-chevron-up" : "bi-chevron-down")"></i>
            </div>
        </div>

        @if (isSurveySectionExpanded)
        {
            <div class="card-body p-4">
                <button class="btn btn-sm mb-3" style="background-color: #a2abf0;" @onclick="OpenAddItemModal">
                    <i class="bi bi-plus-circle me-2"></i>Add New Item
                </button>

                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0">
                        <thead class="text-white" style="background-color: #00066f;">
                            <tr>
                                <th style="width: 120px;">Action</th>
                                <th>Question</th>
                                <th style="width: 200px;">Type</th>
                                <th style="width: 120px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (items.Any())
                            {
                                @foreach (var (item, index) in items.Select((it, i) => (it, i)))
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm" style="background-color: lightblue;"
                                                    @onclick="() => EditItem(item)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm" style="background-color: #ffcccc;"
                                                    @onclick="() => DeleteItem(item.Id)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td>@item.Question</td>
                                        <td>@item.Type.ToString()</td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm" style="background-color: lightblue;"
                                                    @onclick="@(() => ReorderItem(item.Id, "DOWN"))"
                                                    disabled="@(index == items.Count - 1)">
                                                    <i class="bi bi-chevron-down"></i>
                                                </button>
                                                <button class="btn btn-sm" style="background-color: lightblue;"
                                                    @onclick="@(() => ReorderItem(item.Id, "UP"))" disabled="@(index == 0)">
                                                    <i class="bi bi-chevron-up"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        Belum ada pertanyaan. Klik "Add New Item" untuk menambahkan.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
        <button class="btn btn-secondary px-4" @onclick="NewTemplate">
            <i class="bi bi-plus-circle me-2"></i>New
        </button>

        <button class="btn btn-success px-4" @onclick="HandleSubmit" disabled="@isSaving">
            @if (isSaving)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="bi bi-floppy me-2"></i>Submit
        </button>

        <button class="btn btn-danger px-4" @onclick="HandleDelete" disabled="@(headerId == null)">
            <i class="bi bi-trash me-2"></i>Delete
        </button>
    </div>
</div>

@if (showItemModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,.5);" @onclick="CloseItemModal">
        <div class="modal-dialog modal-lg modal-dialog-scrollable" @onclick:stopPropagation>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingItemId.HasValue ? "Edit Item" : "Add New Item")</h5>
                    <button type="button" class="btn-close" @onclick="CloseItemModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Question</label>
                        <input type="text" class="form-control" @bind="currentQuestion" placeholder="Nama Barang" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Type</label>
                        <select class="form-select" @bind="currentType">
                            <option value="">-- Select Type --</option>
                            <option value="Textbox">Textbox</option>
                            <option value="Checkbox">Checkbox</option>
                            <option value="TextArea">TextArea</option>
                            <option value="Number">Number</option>
                        </select>
                    </div>

                    <!-- Checkbox Items Section (hanya muncul jika Type = Checkbox) -->
                    @if (currentType == "Checkbox")
                    {
                        <div class="mt-4">
                            <button class="btn btn-sm btn-primary mb-3" @onclick="AddCheckboxOption">
                                <i class="bi bi-plus-circle me-2"></i>Add New Item
                            </button>

                            <div class="table-responsive">
                                <table class="table table-bordered align-middle">
                                    <thead class="text-white" style="background-color: #00066f;">
                                        <tr>
                                            <th style="width: 100px;">Action</th>
                                            <th>Item</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (currentCheckboxOptions.Any())
                                        {
                                            @foreach (var (opt, idx) in currentCheckboxOptions.Select((o, i) => (o, i)))
                                            {
                                                <tr>
                                                    <td>
                                                        <button class="btn btn-sm" style="background-color: #ffcccc;"
                                                            @onclick="() => DeleteCheckboxOption(idx)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control" @bind="currentCheckboxOptions[idx]"
                                                            placeholder="Item name" />
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="2" class="text-center text-muted py-3">
                                                    Belum ada item. Klik "Add New Item" untuk menambahkan.
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" @onclick="SaveItem">
                        <i class="bi bi-floppy me-2"></i>Save
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="CloseItemModal">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showTemplateModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,.5);" @onclick="CloseTemplateModal">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pilih Survey Template</h5>
                    <button type="button" class="btn-close" @onclick="CloseTemplateModal"></button>
                </div>

                <div class="modal-body">
                    <div class="d-flex gap-2 mb-3">
                        <input class="form-control" placeholder="Cari template code / name..." @bind="templateSearch"
                            @bind:event="oninput" />
                        <button class="btn btn-outline-secondary" @onclick="ClearTemplateSearch">Clear</button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th style="width:220px;">Template Code</th>
                                    <th>Template Name</th>
                                    <th style="width:120px;">Position</th>
                                    <th style="width:180px;">Theme</th>
                                    <th style="width:120px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in FilterTemplates(templateList, templateSearch))
                                {
                                    <tr>
                                        <td>@t.TemplateCode</td>
                                        <td>@t.TemplateName</td>
                                        <td>@t.PositionId</td>
                                        <td>@t.Theme</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-primary" @onclick="() => SelectTemplate(t)">
                                                Pilih
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        @if (templateList.Count == 0)
                        {
                            <div class="text-muted">Tidak ada data template.</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int? HeaderId { get; set; }

    private int? headerId;
    private string templateCode = "Auto-generate";
    private string templateName = "";
    private int positionId = 0;
    private string theme = "";
    private bool showTemplateModal = false;
    private string templateSearch = "";
    private List<SurveyHeaderListDto> templateList = new();

    private bool isSurveySectionExpanded = true;
    private bool showItemModal = false;
    private bool isSaving = false;

    private string errorMessage = "";
    private string successMessage = "";
    private List<PositionDto> positions = new();

    private List<SurveyItemDto> items = new();

    private int? editingItemId = null;
    private string currentQuestion = "";
    private string currentType = "";
    private List<string> currentCheckboxOptions = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "accessToken");
        if (string.IsNullOrEmpty(token))
        {
            Navigation.NavigateTo("/login", forceLoad: true);
            return;
        }

        Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

        await LoadPositions();

        if (HeaderId.HasValue)
            await LoadHeader(HeaderId.Value);

        StateHasChanged(); 
    }

    private async Task LoadPositions()
    {
        try
        {
            positions = await Http.GetFromJsonAsync<List<PositionDto>>("api/positions") ?? new();
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load positions: {ex.Message}";
            positions = new();
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadHeader(int id)
    {
        try
        {
            var detail = await Http.GetFromJsonAsync<SurveyHeaderDetailDto>($"api/survey-templates/{id}");
            if (detail != null)
            {
                headerId = detail.Id;
                templateCode = detail.TemplateCode;
                templateName = detail.TemplateName;
                positionId = detail.PositionId;
                theme = detail.Theme;
                items = detail.Items;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load template: {ex.Message}";
        }
    }

    private void ToggleSurveySection()
    {
        isSurveySectionExpanded = !isSurveySectionExpanded;
    }

    private void OpenAddItemModal()
    {
        if (!headerId.HasValue)
        {
            errorMessage = "Simpan header dulu sebelum menambahkan item";
            return;
        }

        currentQuestion = "";
        currentType = "";
        currentCheckboxOptions = new();
        editingItemId = null;
        showItemModal = true;
    }

    private void EditItem(SurveyItemDto item)
    {
        currentQuestion = item.Question;
        currentType = item.Type.ToString();
        currentCheckboxOptions = item.CheckboxOptions.Select(o => o.Name).ToList();
        editingItemId = item.Id;
        showItemModal = true;
    }

    private void CloseItemModal()
    {
        showItemModal = false;
        currentQuestion = "";
        currentType = "";
        currentCheckboxOptions = new();
        editingItemId = null;
    }

    private void AddCheckboxOption()
    {
        currentCheckboxOptions.Add("");
    }

    private void DeleteCheckboxOption(int index)
    {
        currentCheckboxOptions.RemoveAt(index);
    }

    private async Task SaveItem()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(currentQuestion))
            {
                errorMessage = "Question tidak boleh kosong";
                return;
            }

            if (string.IsNullOrWhiteSpace(currentType))
            {
                errorMessage = "Type harus dipilih";
                return;
            }

            if (!Enum.TryParse<QuestionType>(currentType, out var questionType))
            {
                errorMessage = "Type tidak valid";
                return;
            }

            var options = currentType == "Checkbox"
                            ? currentCheckboxOptions.Where(x => !string.IsNullOrWhiteSpace(x)).ToList()
            : null;

            if (currentType == "Checkbox" && (options == null || !options.Any()))
            {
                errorMessage = "Checkbox harus memiliki minimal 1 item";
                return;
            }

            if (editingItemId.HasValue)
            {
                // Update existing item
                var updateDto = new SurveyItemUpdateDto(currentQuestion, questionType, options);
                var response = await Http.PutAsJsonAsync($"api/survey-templates/items/{editingItemId.Value}", updateDto);
                response.EnsureSuccessStatusCode();
            }
            else
            {
                // Add new item
                var createDto = new SurveyItemCreateDto(currentQuestion, questionType, options);
                var response = await Http.PostAsJsonAsync($"api/survey-templates/{headerId}/items", createDto);
                response.EnsureSuccessStatusCode();
            }

            // Reload items
            await LoadHeader(headerId!.Value);
            CloseItemModal();
            successMessage = editingItemId.HasValue ? "Item berhasil diupdate" : "Item berhasil ditambahkan";
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal menyimpan item: {ex.Message}";
        }
    }

    private async Task DeleteItem(int itemId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Hapus item ini?");
        if (!confirmed) return;

        try
        {
            var response = await Http.DeleteAsync($"api/survey-templates/items/{itemId}");
            response.EnsureSuccessStatusCode();

            await LoadHeader(headerId!.Value);
            successMessage = "Item berhasil dihapus";
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal hapus item: {ex.Message}";
        }
    }

    private async Task ReorderItem(int itemId, string direction)
    {
        try
        {
            var dto = new ReorderItemDto(itemId, direction);
            var response = await Http.PostAsJsonAsync($"api/survey-templates/{headerId}/items/reorder", dto);
            response.EnsureSuccessStatusCode();

            await LoadHeader(headerId!.Value);
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal reorder: {ex.Message}";
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            isSaving = true;
            errorMessage = "";

            if (string.IsNullOrWhiteSpace(templateName))
            {
                errorMessage = "Survey Template Name wajib diisi";
                return;
            }

            if (positionId == 0)
            {
                errorMessage = "Position Level wajib dipilih";
                return;
            }

            if (headerId.HasValue)
            {
                // Update header
                var updateDto = new SurveyHeaderUpdateDto(templateName, positionId, theme);
                var response = await Http.PutAsJsonAsync($"api/survey-templates/{headerId}", updateDto);
                response.EnsureSuccessStatusCode();
                successMessage = "Template berhasil diupdate";
            }
            else
            {
                // Create new header
                var createDto = new SurveyHeaderCreateDto(templateName, positionId, theme);
                var response = await Http.PostAsJsonAsync("api/survey-templates", createDto);
                response.EnsureSuccessStatusCode();

                var created = await response.Content.ReadFromJsonAsync<SurveyHeaderDetailDto>();
                if (created != null)
                {
                    headerId = created.Id;
                    templateCode = created.TemplateCode;
                    Navigation.NavigateTo($"/master-template-survey/{created.Id}");
                }
                successMessage = "Template berhasil dibuat";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task HandleDelete()
    {
        if (!headerId.HasValue) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Hapus template ini?");
        if (!confirmed) return;

        try
        {
            var response = await Http.DeleteAsync($"api/survey-templates/{headerId}");
            response.EnsureSuccessStatusCode();

            Navigation.NavigateTo("/survey-template-list");
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal hapus template: {ex.Message}";
        }
    }
    private async Task OpenTemplateModal()
    {
        showTemplateModal = true;
        templateSearch = "";
        await LoadTemplates(); // load dari API
    }

    private void CloseTemplateModal()
    {
        showTemplateModal = false;
    }

    private void ClearTemplateSearch()
    {
        templateSearch = "";
    }

    private async Task LoadTemplates()
    {
        try
        {
            // pakai endpoint list yang kamu sudah punya: GET api/survey-templates
            var data = await Http.GetFromJsonAsync<List<SurveyHeaderListDto>>("api/survey-templates");
            templateList = data ?? new();
        }
        catch (Exception ex)
        {
            errorMessage = $"Gagal load templates: {ex.Message}";
            templateList = new();
        }
    }

    private IEnumerable<SurveyHeaderListDto> FilterTemplates(List<SurveyHeaderListDto> data, string q)
    {
        if (data == null) return Enumerable.Empty<SurveyHeaderListDto>();
        if (string.IsNullOrWhiteSpace(q)) return data;

        q = q.Trim().ToLowerInvariant();

        return data.Where(x =>
        (x.TemplateCode ?? "").ToLowerInvariant().Contains(q) ||
        (x.TemplateName ?? "").ToLowerInvariant().Contains(q) ||
        (x.Theme ?? "").ToLowerInvariant().Contains(q) ||
        x.PositionId.ToString().Contains(q)
        );
    }

    private async Task SelectTemplate(SurveyHeaderListDto t)
    {
        CloseTemplateModal();

        Navigation.NavigateTo($"/master-template-survey/{t.Id}", forceLoad: true);

        // kalau gak mau forceLoad bisa langsung:
        // HeaderId = t.Id;
        // await LoadHeader(t.Id);
    }
    private void NewTemplate()
    {
        // reset route + state
        HeaderId = null;
        headerId = null;

        templateCode = "Auto-generate";
        templateName = "";
        positionId = 0;
        theme = "";

        items = new();
        editingItemId = null;
        showItemModal = false;
        showTemplateModal = false;

        errorMessage = "";
        successMessage = "";

        // balik ke create mode (tanpa id)
        Navigation.NavigateTo("/master-template-survey", forceLoad: true);
    }

}