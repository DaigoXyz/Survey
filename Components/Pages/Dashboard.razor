@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Survey.Helpers
@using Survey.Services.Document
@using Survey.Services.Survey
@using Survey.DTOs.Document
@using Survey.Entities.DocumentEntities
@attribute [Authorize]
@inject IDocumentSurveyService DocumentService
@inject ISurveyTemplateService TemplateService
@inject NavigationManager Navigation
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Dashboard - Survey System</PageTitle>

<div class="container-fluid p-4">
    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center min-vh-50">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Welcome Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm bg-primary text-white">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h2 class="mb-2 fw-bold text-white">Welcome back, @userName!</h2>
                                <p class="mb-0 text-white-50">
                                    <i class="bi bi-shield-check me-2"></i>@userRole
                                    <span class="mx-2">â€¢</span>
                                    <i class="bi bi-calendar3 me-2"></i>@DateTime.Now.ToString("dddd, dd MMMM yyyy")
                                </p>
                            </div>
                            <div class="d-none d-lg-block text-white-50">
                                <i class="bi bi-person-circle display-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-muted mb-1 small">Total Documents</p>
                                <h3 class="mb-0 fw-bold">@recentDocuments.Count</h3>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-3 rounded">
                                <i class="bi bi-file-earmark-text text-primary fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-muted mb-1 small">Draft</p>
                                <h3 class="mb-0 fw-bold">@draftCount</h3>
                            </div>
                            <div class="bg-warning bg-opacity-10 p-3 rounded">
                                <i class="bi bi-pencil-square text-warning fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-muted mb-1 small">Confirm To Approve</p>
                                <h3 class="mb-0 fw-bold">@pendingCount</h3>
                            </div>
                            <div class="bg-info bg-opacity-10 p-3 rounded">
                                <i class="bi bi-clock-history text-info fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="text-muted mb-1 small">Confirmed</p>
                                <h3 class="mb-0 fw-bold">@approvedCount</h3>
                            </div>
                            <div class="bg-success bg-opacity-10 p-3 rounded">
                                <i class="bi bi-check-circle text-success fs-4"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-lightning-charge-fill text-warning me-2"></i>Quick Actions
                        </h5>
                        <div class="row g-2">
                            @if(!IsSupervisor){
                            <div class="col-lg-3 col-md-6">
                                <a href="/survey/document" class="btn btn-outline-primary w-100 py-3">
                                    <i class="bi bi-plus-circle me-2"></i>Create Survey
                                </a>
                            </div>
                            }
                            <div class="col-lg-3 col-md-6">
                                <a href="/survey/list" class="btn btn-outline-secondary w-100 py-3">
                                    <i class="bi bi-list-ul me-2"></i>View All Surveys
                                </a>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <a href="/master-template-survey" class="btn btn-outline-success w-100 py-3">
                                    <i class="bi bi-folder-plus me-2"></i>Create Template
                                </a>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <a href="/survey/template-list" class="btn btn-outline-info w-100 py-3">
                                    <i class="bi bi-collection me-2"></i>View Templates
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Recent Survey Documents -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-file-earmark-text me-2 text-primary"></i>Recent Survey Documents
                            </h5>
                            <a href="/survey/list" class="btn btn-sm btn-outline-primary">
                                View All <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        @if (recentDocuments.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-4">Document No</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Requester</th>
                                            <th class="text-center pe-4">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var doc in recentDocuments.Take(5))
                                        {
                                            <tr>
                                                <td class="ps-4">
                                                    <span class="fw-semibold">@doc.DocumentNo</span>
                                                </td>
                                                <td>
                                                    <small class="text-muted">@doc.DocumentDate.ToString("dd MMM yyyy")</small>
                                                </td>
                                                <td>
                                                    <span class="badge @GetStatusBadgeClass(doc.Status) px-3 py-2">
                                                        @GetStatusText(doc.Status)
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="bg-secondary bg-opacity-10 rounded-circle p-2 me-2">
                                                            <i class="bi bi-person-fill text-secondary"></i>
                                                        </div>
                                                        <div>
                                                            <div class="fw-semibold small">@doc.RequesterEmployeeName</div>
                                                            <small class="text-muted">@doc.RequesterPositionName</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="text-center pe-4">
                                                    <a href="/survey/document/@doc.Id" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-inbox text-muted display-1"></i>
                                <p class="text-muted mt-3 mb-0">No survey documents yet</p>
                                <a href="/survey/document" class="btn btn-sm btn-primary mt-3">
                                    <i class="bi bi-plus-circle me-1"></i>Create Your First Survey
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Activity Summary & Templates -->
            <div class="col-lg-4">
                <!-- Activity Summary -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up me-2 text-success"></i>Activity Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">This Month</span>
                                <span class="badge bg-primary">@thisMonthCount</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar"
                                    style="width: @GetProgressPercentage(thisMonthCount, recentDocuments.Count)%"
                                    aria-valuenow="@thisMonthCount" aria-valuemin="0"
                                    aria-valuemax="@recentDocuments.Count">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">Last 7 Days</span>
                                <span class="badge bg-info">@last7DaysCount</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-info" role="progressbar"
                                    style="width: @GetProgressPercentage(last7DaysCount, recentDocuments.Count)%"
                                    aria-valuenow="@last7DaysCount" aria-valuemin="0"
                                    aria-valuemax="@recentDocuments.Count">
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">Completion Rate</span>
                                <span class="badge bg-success">@completionRate%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: @completionRate%"
                                    aria-valuenow="@completionRate" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthStateTask { get; set; }

    private string userName = "Guest";
    private string userRole = "None";
    private int userId = 0;
    private bool isLoading = true;
    private bool IsSupervisor => userRole.Equals("Supervisor", StringComparison.OrdinalIgnoreCase);

    private List<DocumentSurveyDto> recentDocuments = new();
    private List<SurveyHeaderListDto> recentTemplates = new();

    private int draftCount = 0;
    private int pendingCount = 0;
    private int approvedCount = 0;
    private int thisMonthCount = 0;
    private int last7DaysCount = 0;
    private int completionRate = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (AuthStateTask != null)
            {
                var authState = await AuthStateTask;
                var user = authState.User;

                if (user.Identity?.IsAuthenticated ?? false)
                {
                    userName = user.Identity.Name ?? "Unknown";
                    userRole = user.FindFirstValue(ClaimTypes.Role) ?? "No Role";
                    userId = AuthClaims.GetUserId(user);

                    // Load documents
                    recentDocuments = await DocumentService.GetListForCurrentUserAsync(userId, userRole);

                    // Calculate stats
                    CalculateStats();

                    // Load templates if supervisor
                    if (IsSupervisor)
                    {
                        recentTemplates = await TemplateService.ListAsync(CancellationToken.None);
                        var positionId = AuthClaims.GetPositionId(user);
                        recentTemplates = recentTemplates.Where(t => t.PositionId == positionId).ToList();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CalculateStats()
    {
        draftCount = recentDocuments.Count(d => d.Status == 1);
        pendingCount = recentDocuments.Count(d => d.Status == 2);
        approvedCount = recentDocuments.Count(d => d.Status == 3);

        var now = DateTime.Now;
        thisMonthCount = recentDocuments.Count(d =>
        d.DocumentDate.Year == now.Year &&
        d.DocumentDate.Month == now.Month);

        last7DaysCount = recentDocuments.Count(d =>
        (now - d.DocumentDate).TotalDays <= 7);

        if (recentDocuments.Any())
        {
            completionRate = (int)((double)approvedCount / recentDocuments.Count * 100);
        }
    }

    private string GetStatusBadgeClass(int status)
    {
        return status switch
        {
            0 => "bg-secondary",
            1 => "bg-warning text-dark",
            2 => "bg-info text-dark",
            3 => "bg-success",
            _ => "bg-secondary"
        };
    }

    private string GetStatusText(int status)
    {
        return status switch
        {
            0 => "New",
            1 => "Draft",
            2 => "Confirm To Approve",
            3 => "Confirmed",
            _ => "Unknown"
        };
    }

    private int GetProgressPercentage(int value, int total)
    {
        if (total == 0) return 0;
        return (int)((double)value / total * 100);
    }
}